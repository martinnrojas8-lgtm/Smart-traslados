<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Traslados ‚Äì Panel Propietario</title>

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#000;
    color:#fff;
}
header{
    background:#111;
    padding:15px;
    text-align:center;
    font-size:22px;
    font-weight:bold;
}
.menu{
    display:flex;
    flex-wrap:wrap;
    background:#1a1a1a;
}
.menu button{
    flex:1;
    padding:15px;
    border:none;
    background:#1a1a1a;
    color:#fff;
    cursor:pointer;
    font-size:14px;
}
.menu button:hover{
    background:#333;
}
.pantalla{
    display:none;
    padding:20px;
}
.activa{
    display:block;
}
.card{
    background:#111;
    padding:15px;
    border-radius:10px;
    margin-bottom:15px;
}
input, select{
    width:100%;
    padding:10px;
    margin-top:8px;
    margin-bottom:12px;
    border-radius:6px;
    border:none;
    background: #fff; /* Mantengo tus campos blancos originales */
    color: #000;
}
table{
    width:100%;
    border-collapse:collapse;
}
th, td{
    padding:10px;
    border-bottom:1px solid #333;
    text-align:left;
    font-size:14px;
}
.estado-ok{ color:#4caf50; }
.estado-off{ color:#f44336; }
.btn{
    padding:8px 12px;
    border:none;
    border-radius:6px;
    cursor:pointer;
}
.btn-ok{ background:#4caf50; }
.btn-del{ background:#f44336; }

/* Solo agrego esto para que se vea la ficha del PIN cuando la generes */
#contenedorFicha { 
    display: none; flex-direction: column; align-items: center; 
    background: #fff; padding: 20px; border-radius: 15px; 
    max-width: 280px; margin: 20px auto; color: #000;
}
.ficha-codigo { font-size: 30px; font-weight: bold; color: #4caf50; letter-spacing: 4px; }
</style>
</head>

<body>

<header>üìä Smart Traslados ‚Äì Panel General</header>

<div class="menu">
    <button onclick="mostrar('inicio')">Inicio</button>
    <button onclick="mostrar('conductores')">Conductores</button>
    <button onclick="mostrar('pasajeros')">Pasajeros</button>
    <button onclick="mostrar('viajes')">Viajes</button>
    <button onclick="mostrar('pagos')">Historial Cobros</button>
    <button onclick="mostrar('tarifas')">Tarifas</button>
    <button onclick="mostrar('mensajes')">Mensajes</button>
    <button onclick="mostrar('config')">Configuraci√≥n</button>
</div>

<div id="inicio" class="pantalla activa">
    <div class="card">
        <h3>Resumen general</h3>
        <p>Conductores registrados: <b id="cActivos">0</b></p>
        <p>Pasajeros registrados: <b id="pTotal">0</b></p>
        <p>Viajes del d√≠a: <b id="vHoy">0</b></p>
    </div>
</div>

<div id="conductores" class="pantalla">
    <div class="card">
        <h3>Conductores</h3>
        <table id="tablaConductores">
            <tr><th>Nombre</th><th>Tel√©fono</th><th>Estado</th><th>Acci√≥n</th></tr>
        </table>
    </div>
</div>

<div id="pasajeros" class="pantalla">
    <div class="card">
        <h3>Pasajeros</h3>
        <table id="tablaPasajeros">
            <tr><th>Nombre</th><th>Tel√©fono</th></tr>
        </table>
    </div>
</div>

<div id="viajes" class="pantalla">
    <div class="card">
        <h3>Historial de viajes</h3>
        <table id="tablaViajes">
            <tr><th>Fecha</th><th>Chofer</th><th>Pasajero</th><th>Monto</th></tr>
        </table>
    </div>
</div>

<div id="pagos" class="pantalla">
    <div class="card" style="text-align:center;">
        <h3>Generar Pin de Activaci√≥n 24hs</h3>
        <button class="btn btn-ok" onclick="generarNuevoCodigo()">GENERAR NUEVO C√ìDIGO</button>
        
        <div id="contenedorFicha">
            <div style="font-weight:bold;">Smart Traslados</div>
            <div id="txtFichaCodigo" class="ficha-codigo">000000</div>
            <div>V√°lido por 24 Horas</div>
        </div>
    </div>
</div>

<div id="tarifas" class="pantalla">
    <div class="card">
        <h3>Tarifas</h3>
        <label>Precio base por viaje</label>
        <input type="number" id="precioBase">
        <label>Precio por km</label>
        <input type="number" id="precioKm">
        <button class="btn btn-ok" onclick="guardarTarifas()">Guardar cambios</button>
    </div>
</div>

<div id="mensajes" class="pantalla">
    <div class="card">
        <h3>Enviar mensaje</h3>
        <select>
            <option>Todos los conductores</option>
            <option>Todos los pasajeros</option>
        </select>
        <input type="text" placeholder="Escrib√≠ el mensaje">
        <button class="btn btn-ok">Enviar</button>
    </div>
</div>

<div id="config" class="pantalla">
    <div class="card">
        <h3>Configuraci√≥n general</h3>
        <label>Nombre de la app</label>
        <input value="Smart Traslados">
        <label>Tel√©fono soporte</label>
        <input value="+54 9">
        <label>Email soporte</label>
        <input value="soporte@smart.com">
        <label>Cuenta bancaria para recibir pagos (token/ID)</label>
        <input id="cuentaBancaria" placeholder="Ingres√° tu token o ID">
        <button class="btn btn-ok">Guardar configuraci√≥n</button>
    </div>
</div>

<script>
function mostrar(id){
    document.querySelectorAll('.pantalla').forEach(p=>p.classList.remove('activa'));
    document.getElementById(id).classList.add('activa');
}

// 1. VINCULACI√ìN DE TARIFAS
async function cargarTarifas() {
    try {
        const res = await fetch('/obtener-tarifas');
        const data = await res.json();
        document.getElementById('precioBase').value = data.precioBase || 500;
        document.getElementById('precioKm').value = data.precioKm || 150;
    } catch (e) {}
}

async function guardarTarifas() {
    const pBase = parseInt(document.getElementById('precioBase').value);
    const pKm = parseInt(document.getElementById('precioKm').value);
    try {
        await fetch('/actualizar-tarifas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ precioBase: pBase, precioKm: pKm })
        });
        alert('Tarifas guardadas en el servidor');
    } catch (e) { alert('Error al guardar'); }
}

// 2. VINCULACI√ìN DE PIN (NUEVA RUTA)
async function generarNuevoCodigo() {
    const nuevoCod = Math.floor(100000 + Math.random() * 900000).toString();
    try {
        const res = await fetch('/crear-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codigo: nuevoCod })
        });
        if(res.ok) {
            document.getElementById('txtFichaCodigo').innerText = nuevoCod;
            document.getElementById('contenedorFicha').style.display = 'flex';
        }
    } catch (e) { alert("Error al generar"); }
}

// 3. VINCULACI√ìN DE CONDUCTORES Y PASAJEROS REALES
async function cargarDatosReales() {
    try {
        const res = await fetch('/obtener-usuarios');
        const usuarios = await res.json();
        const conds = usuarios.filter(u => u.rol === 'chofer');
        const pasas = usuarios.filter(u => u.rol === 'pasajero');

        document.getElementById('cActivos').innerText = conds.length;
        document.getElementById('pTotal').innerText = pasas.length;

        let tC = document.getElementById('tablaConductores');
        tC.innerHTML = `<tr><th>Nombre</th><th>Tel√©fono</th><th>Estado</th><th>Acci√≥n</th></tr>`;
        conds.forEach(c => {
            const activo = c.vencimientoPago && new Date(c.vencimientoPago) > new Date();
            tC.innerHTML += `<tr>
                <td>${c.nombre || 'S/N'}</td>
                <td>${c.telefono}</td>
                <td class="${activo?'estado-ok':'estado-off'}">${activo?'Al d√≠a':'Vencido'}</td>
                <td><button class="btn btn-del">Bloquear</button></td>
            </tr>`;
        });

        let tP = document.getElementById('tablaPasajeros');
        tP.innerHTML = `<tr><th>Nombre</th><th>Tel√©fono</th></tr>`;
        pasas.forEach(p => {
            tP.innerHTML += `<tr><td>${p.nombre || 'S/N'}</td><td>${p.telefono}</td></tr>`;
        });
    } catch (e) {}
}

window.onload = () => {
    cargarTarifas();
    cargarDatosReales();
};
</script>

</body>
</html>
