<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Traslados ‚Äì Panel Propietario</title>

<style>
body{ margin:0; font-family:Arial, sans-serif; background:#000; color:#fff; }
header{ background:#111; padding:15px; text-align:center; font-size:22px; font-weight:bold; border-bottom: 2px solid #4caf50; }
.menu{ display:flex; flex-wrap:wrap; background:#1a1a1a; }
.menu button{ flex:1; padding:15px; border:none; background:#1a1a1a; color:#fff; cursor:pointer; font-size:14px; border-bottom: 1px solid #333; }
.menu button:hover{ background:#333; }
.pantalla{ display:none; padding:20px; }
.activa{ display:block; }
.card{ background:#111; padding:15px; border-radius:10px; margin-bottom:15px; border: 1px solid #333; }
input, select{ width:100%; padding:10px; margin-top:8px; margin-bottom:12px; border-radius:6px; border:none; background: #fff; color: #000; }
table{ width:100%; border-collapse:collapse; margin-top:10px; }
th, td{ padding:12px 8px; border-bottom:1px solid #333; text-align:left; font-size:13px; }
.estado-ok{ color:#4caf50; font-weight:bold; }
.estado-off{ color:#f44336; font-weight:bold; }
.btn{ padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-weight: bold; }
.btn-ok{ background:#4caf50; color: #fff; }
.btn-del{ background:#f44336; color: #fff; }
.btn-doc{ background:#444; color:#fff; font-size:10px; padding:5px; margin-right:2px; }

/* FICHA PIN */
#contenedorFicha { 
    display: none; flex-direction: column; align-items: center; 
    background: #fff; padding: 25px; border-radius: 20px; 
    max-width: 260px; margin: 20px auto; color: #000; 
    border: 2px solid #4caf50; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}
.ficha-logo { width: 80px; height: auto; margin-bottom: 10px; border-radius: 10px; }
.ficha-codigo { font-size: 38px; font-weight: bold; color: #4caf50; letter-spacing: 5px; margin: 10px 0; padding: 5px 15px; background: #f0f0f0; border-radius: 8px; border: 1px dashed #4caf50; }
</style>
</head>

<body>

<header>üìä Smart Traslados ‚Äì Panel General</header>

<div class="menu">
    <button onclick="mostrar('inicio')">Inicio</button>
    <button onclick="mostrar('conductores')">Conductores</button>
    <button onclick="mostrar('pasajeros')">Pasajeros</button>
    <button onclick="mostrar('viajes')">Viajes</button>
    <button onclick="mostrar('pagos')">Historial Cobros</button>
    <button onclick="mostrar('tarifas')">Tarifas</button>
    <button onclick="mostrar('mensajes')">Mensajes</button>
    <button onclick="mostrar('config')">Configuraci√≥n</button>
</div>

<div id="inicio" class="pantalla activa">
    <div class="card">
        <h3>Resumen operativo</h3>
        <p>Conductores registrados: <b id="cActivos">0</b></p>
        <p>Pasajeros registrados: <b id="pTotal">0</b></p>
    </div>
</div>

<div id="conductores" class="pantalla">
    <div class="card">
        <h3>Gesti√≥n de Conductores</h3>
        <div style="overflow-x:auto;">
            <table id="tablaConductores">
                <tr>
                    <th>Chofer / Tel</th>
                    <th>Documentos</th>
                    <th>Estado</th>
                    <th>Recaudado (D/S/M)</th>
                    <th>Acciones</th>
                </tr>
            </table>
        </div>
    </div>
</div>

<div id="pasajeros" class="pantalla">
    <div class="card">
        <h3>Pasajeros Registrados</h3>
        <table id="tablaPasajeros">
            <tr><th>Nombre</th><th>Tel√©fono</th></tr>
        </table>
    </div>
</div>

<div id="viajes" class="pantalla">
    <div class="card">
        <h3>Monitor de Viajes</h3>
        <p>Registro de rutas y estados.</p>
    </div>
</div>

<div id="pagos" class="pantalla">
    <div class="card" style="text-align:center;">
        <h3>Generar Pin de Activaci√≥n 24hs</h3>
        <button class="btn btn-ok" onclick="generarNuevoCodigo()" style="width:100%">GENERAR NUEVO C√ìDIGO</button>
        <div id="contenedorFicha">
            <img src="logo.png" class="ficha-logo" onerror="this.src='https://via.placeholder.com/80?text=Smart+Logo'">
            <div style="font-weight:bold; text-transform:uppercase;">Smart Traslados</div>
            <div id="txtFichaCodigo" class="ficha-codigo">000000</div>
            <div style="font-size:12px; font-weight:bold; color:#666;">V√ÅLIDO POR 24 HORAS</div>
        </div>
        <p id="instruccionFicha" style="display:none; color: #4caf50; font-size: 12px; margin-top: 15px;">‚Üë Sac√° captura y envi√° al chofer ‚Üë</p>
    </div>
</div>

<div id="tarifas" class="pantalla">
    <div class="card">
        <h3>Tarifas</h3>
        <label>Precio base por viaje (Pasajeros)</label>
        <input type="number" id="precioBase">
        <label>Precio por km (Pasajeros)</label>
        <input type="number" id="precioKm">
        <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
        <label>Monto sugerido suscripci√≥n 24hs (Info Admin)</label>
        <input type="number" id="montoFijo">
        <button class="btn btn-ok" onclick="guardarTarifas()" style="width:100%">Guardar cambios</button>
    </div>
</div>

<div id="mensajes" class="pantalla">
    <div class="card">
        <h3>Enviar Comunicaci√≥n Masiva</h3>
        <select><option>Todos los conductores</option><option>Todos los pasajeros</option></select>
        <input type="text" placeholder="Escrib√≠ el mensaje">
        <button class="btn btn-ok" style="width:100%">Enviar</button>
    </div>
</div>

<div id="config" class="pantalla">
    <div class="card">
        <h3>Configuraci√≥n de Contacto</h3>
        <label>Nombre de la app</label>
        <input id="confApp" value="Smart Traslados">
        <label>Tel√©fono soporte</label>
        <input id="confTel" value="+54 9">
        <label>Alias / CBU para Cobros</label>
        <input id="confAlias">
        <button class="btn btn-ok" onclick="guardarConfiguracion()" style="width:100%">Guardar configuraci√≥n</button>
    </div>
</div>

<script>
function mostrar(id){
    document.querySelectorAll('.pantalla').forEach(p=>p.classList.remove('activa'));
    document.getElementById(id).classList.add('activa');
}

async function cargarDatosReales() {
    try {
        const res = await fetch('/obtener-usuarios');
        const usuarios = await res.json();
        const conds = usuarios.filter(u => u.rol === 'chofer');
        const pasas = usuarios.filter(u => u.rol === 'pasajero');

        document.getElementById('cActivos').innerText = conds.length;
        document.getElementById('pTotal').innerText = pasas.length;

        let tC = document.getElementById('tablaConductores');
        tC.innerHTML = `<tr><th>Chofer / Tel</th><th>Documentos</th><th>Estado</th><th>Recaudado (D/S/M)</th><th>Acciones</th></tr>`;
        
        conds.forEach(c => {
            const activo = c.vencimientoPago && new Date(c.vencimientoPago) > new Date();
            tC.innerHTML += `<tr>
                <td><b>${c.nombre || 'S/N'}</b><br><small>${c.telefono}</small></td>
                <td>
                    <button class="btn-doc" onclick="verDoc('${c.fotoCarnet}')">CARNET</button>
                    <button class="btn-doc" onclick="verDoc('${c.fotoSeguro}')">SEGURO</button>
                </td>
                <td class="${activo?'estado-ok':'estado-off'}">${activo?'ACTIVO':'VENCIDO'}</td>
                <td>$${c.recaudadoDia||0} / $${c.recaudadoSemana||0} / $${c.recaudadoMes||0}</td>
                <td>
                    <button class="btn-ok" style="padding:4px 8px;" onclick="activarManual('${c.telefono}')">‚úî</button>
                    <button class="btn-del" style="padding:4px 8px;" onclick="eliminarChofer('${c.telefono}')">‚úñ</button>
                    <button class="btn" style="background:#25d366; padding:4px 8px;" onclick="mensajeInd('${c.telefono}')">‚úâ</button>
                </td>
            </tr>`;
        });

        let tP = document.getElementById('tablaPasajeros');
        tP.innerHTML = `<tr><th>Nombre</th><th>Tel√©fono</th></tr>`;
        pasas.forEach(p => { tP.innerHTML += `<tr><td>${p.nombre || 'S/N'}</td><td>${p.telefono}</td></tr>`; });
    } catch (e) {}
}

function verDoc(url) { 
    if(!url || url === 'undefined') return alert("Sin foto cargada."); 
    window.open(url, '_blank'); 
}

function mensajeInd(tel) { 
    const m = prompt("Mensaje de aviso (WhatsApp):"); 
    if(m) window.open(`https://wa.me/${tel}?text=${encodeURIComponent(m)}`, '_blank'); 
}

async function activarManual(tel) { 
    alert("Activaci√≥n manual para " + tel + " (Requiere endpoint /activar)"); 
}

async function eliminarChofer(tel) { 
    if(confirm("¬øEliminar chofer definitivamente?")) alert("Eliminado: " + tel); 
}

async function generarNuevoCodigo() {
    const nuevoCod = Math.floor(100000 + Math.random() * 900000).toString();
    try {
        const res = await fetch('/crear-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codigo: nuevoCod })
        });
        if(res.ok) {
            document.getElementById('txtFichaCodigo').innerText = nuevoCod;
            document.getElementById('contenedorFicha').style.display = 'flex';
            document.getElementById('instruccionFicha').style.display = 'block';
        }
    } catch (e) { alert("Error en servidor"); }
}

async function cargarTarifas() {
    try {
        const res = await fetch('/obtener-tarifas');
        const data = await res.json();
        document.getElementById('precioBase').value = data.precioBase || 500;
        document.getElementById('precioKm').value = data.precioKm || 150;
        document.getElementById('montoFijo').value = localStorage.getItem('montoFijoInfo') || 10000;
    } catch (e) {}
}

async function guardarTarifas() {
    const pBase = parseInt(document.getElementById('precioBase').value);
    const pKm = parseInt(document.getElementById('precioKm').value);
    try {
        await fetch('/actualizar-tarifas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ precioBase: pBase, precioKm: pKm })
        });
        localStorage.setItem('montoFijoInfo', document.getElementById('montoFijo').value);
        alert('Tarifas actualizadas correctamente');
    } catch (e) { alert('Error al guardar'); }
}

function guardarConfiguracion() {
    const config = { app: document.getElementById('confApp').value, tel: document.getElementById('confTel').value, alias: document.getElementById('confAlias').value };
    localStorage.setItem('configAdmin', JSON.stringify(config));
    alert('Configuraci√≥n guardada');
}

function cargarConfiguracion() {
    const config = JSON.parse(localStorage.getItem('configAdmin'));
    if(config) {
        document.getElementById('confApp').value = config.app;
        document.getElementById('confTel').value = config.tel;
        document.getElementById('confAlias').value = config.alias;
    }
}

window.onload = () => {
    cargarTarifas();
    cargarDatosReales();
    cargarConfiguracion();
};
</script>
</body>
</html>
