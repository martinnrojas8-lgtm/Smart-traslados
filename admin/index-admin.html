<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control Smart - Saladillo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel="apple-touch-icon" href="/file_000000008fd0720eb71af76359ccb359.png">
<link rel="manifest" href="/manifest-admin.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<style>
  body{ margin:0; font-family:Arial, sans-serif; background:#000; color:#fff; }
  header{ background:#111; padding:15px; border-bottom:2px solid #00c853; display:flex; justify-content:space-between; align-items:center; }
  .container{ padding:15px; }
  .grid{ display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
  @media(max-width:768px){ .grid{ grid-template-columns: 1fr; } }
  
  .card-admin{ background:#111; border:1px solid #333; border-radius:12px; padding:15px; margin-bottom:15px; }
  .chofer-row{ display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #222; }
  .chofer-row:last-child{ border:0; }
  
  h3{ color:#00c853; margin-top:0; font-size:14px; text-transform:uppercase; letter-spacing:1px; border-bottom: 1px solid #333; padding-bottom: 5px; }
  .nombre{ font-weight:bold; color:#fff; display:block; }
  .tel{ font-size:12px; color:#888; }
  
  .badge{ padding:4px 8px; border-radius:5px; font-size:10px; font-weight:bold; }
  .status-disponible{ background:rgba(0,200,83,0.2); color:#00c853; }
  .status-ocupado{ background:rgba(255,82,82,0.2); color:#ff5252; }
  
  button{ padding:8px 12px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:11px; }
  .btn-salir{ background:transparent; color:#ff5252; border:1px solid #ff5252; }
  
  .monitor-viajes{ background:#111; border:1px solid #00c853; border-radius:12px; padding:15px; }
  .btn-activar{ background:#ffb300; color:#000; margin-top: 5px; }
</style>
</head>
<body>

<header>
  <div style="display:flex; align-items:center; gap:10px;">
    <img src="/file_000000008fd0720eb71af76359ccb359.png" width="30">
    <h2 style="margin:0; font-size:16px;">Control Smart</h2>
  </div>
  <button class="btn-salir" onclick="cerrarSesion()">SALIR</button>
</header>

<div class="container">
    <div class="grid">
        <div class="card-admin">
            <h3>Choferes en Saladillo</h3>
            <div id="listaEnVivo">
                <p style="color:#444;">Buscando señal...</p>
            </div>
        </div>

        <div class="monitor-viajes">
            <h3>Pedidos Hoy</h3>
            <div id="listaPedidos">
                <p style="color:#444;">Sin pedidos ahora.</p>
            </div>
        </div>
    </div>

    <div class="card-admin" style="margin-top:15px;">
        <h3>Administración de Choferes</h3>
        <div id="gestionCuentas">
            </div>
    </div>
</div>

<script>
/* SEGURIDAD */
function cerrarSesion(){
    localStorage.removeItem("adminAuth");
    location.href = "/";
}

/* LÓGICA DE ACTUALIZACIÓN */
function actualizarTodo() {
    // 1. Obtener Choferes en línea
    fetch("/obtener-choferes-activos")
    .then(r => r.json())
    .then(choferes => {
        const divVivo = document.getElementById("listaEnVivo");
        const divGestion = document.getElementById("gestionCuentas");
        divVivo.innerHTML = "";
        divGestion.innerHTML = "";

        choferes.forEach(c => {
            // Fila para el Monitor
            const row = document.createElement("div");
            row.className = "chofer-row";
            row.innerHTML = `
                <div><span class="nombre">${c.telefono}</span></div>
                <span class="badge status-${c.estado}">${c.estado.toUpperCase()}</span>
            `;
            divVivo.appendChild(row);

            // Fila para la Gestión (Activar 24hs)
            const cardG = document.createElement("div");
            cardG.className = "chofer-row";
            cardG.innerHTML = `
                <div><span class="nombre">${c.telefono}</span><span class="tel">Estado: ${c.estado}</span></div>
                <button class="btn-activar" onclick="activarManual('${c.telefono}')">ACTIVAR 24HS</button>
            `;
            divGestion.appendChild(cardG);
        });
    });

    // 2. Obtener pedidos
    fetch("/verificar-pedidos")
    .then(r => r.json())
    .then(v => {
        const divP = document.getElementById("listaPedidos");
        if(v && v.activo) {
            divP.innerHTML = `
                <div style="background:#222; padding:10px; border-radius:8px; border-left:4px solid #00c853;">
                    <p style="margin:0; font-size:13px;"><b>DE:</b> ${v.origen}</p>
                    <p style="margin:5px 0; font-size:13px;"><b>A:</b> ${v.destino}</p>
                    <p style="margin:0; color:#00c853; font-weight:bold;">${v.precio}</p>
                </div>`;
        } else {
            divP.innerHTML = "<p style='color:#444;'>Sin actividad.</p>";
        }
    });
}

function activarManual(tel) {
    if(confirm("¿Activar 24hs para el chofer " + tel + "?")) {
        alert("Activado correctamente.");
    }
}

setInterval(actualizarTodo, 5000);
actualizarTodo();
</script>
</body>
</html>
