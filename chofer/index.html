<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Smart Traslados – Chofer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="/manifest.json">
<link rel="icon" type="image/png" href="/file_000000008fd0720eb71af76359ccb359.png">

<style>
  body{ margin:0; font-family:Arial, sans-serif; background:#000; color:#fff; }
  header{ background:#111; padding:15px; text-align:center; border-bottom:2px solid #00c853; }
  .screen{ padding:15px; }
  .card{ background:#111; border-radius:12px; padding:15px; margin-bottom:15px; border:1px solid #333; }
  h3{ margin-top:0; color:#00c853; font-size:16px; }
  #map{ width:100%; height:300px; border-radius:10px; margin-bottom:10px; background:#222; }
  button{ padding:12px; width:100%; margin-top:10px; border:none; border-radius:8px; background:#00c853; color:#000; font-weight:bold; cursor:pointer; }
  .logout{ background:#333; color:#aaa; font-size:12px; margin-top:20px; }
  .hidden{ display:none; }
  .info-viaje{ background:#222; padding:10px; border-radius:8px; margin-top:10px; border-left:4px solid #00c853; }
  .price-tag{ font-size:22px; color:#00c853; font-weight:bold; display:block; margin-top:5px; }
</style>
</head>
<body>

<header>
  <h2 style="margin:0; font-size:18px;">Smart Chofer</h2>
  <div id="userInfo" style="font-size:12px; color:#aaa;">Cargando...</div>
</header>

<div class="screen">
  <div class="card">
    <h3>Mi Ubicación</h3>
    <div id="map"></div>
  </div>

  <div id="panelSolicitud" class="card">
    <h3>Estado: Disponible</h3>
    <div id="detalleViaje">Esperando nuevos pedidos de pasajeros...</div>
    
    <div id="datosViaje" class="hidden">
        <div class="info-viaje">
            <strong>Ruta:</strong> <span id="rutaTexto">...</span><br>
            <strong>Cobrar:</strong> <span id="precioTexto" class="price-tag">$0.00</span>
        </div>
        <button id="btnAceptar" onclick="aceptarViaje()">ACEPTAR VIAJE</button>
    </div>
  </div>

  <button class="logout" onclick="cerrarSesion()">CERRAR SESIÓN</button>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB8zZaje1NKai0k2MxuQvQVW6vrRdfUIrY&libraries=places"></script>

<script>
let map, directionsRenderer, directionsService, userMarker;
const sesion = JSON.parse(localStorage.getItem("sesion") || "{}");

if(!sesion || sesion.rol !== "chofer") { location.href = "/"; }
document.getElementById("userInfo").innerText = "Chofer: " + sesion.telefono;

function initMap() {
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
        polylineOptions: { strokeColor: "#00c853", strokeWeight: 5 }
    });

    if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            const myPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            map = new google.maps.Map(document.getElementById("map"), {
                center: myPos,
                zoom: 15,
                disableDefaultUI: true,
                styles: [{ "featureType": "all", "elementType": "labels.text.fill", "stylers": [{"color": "#ffffff"}] }] // Modo oscuro básico
            });
            directionsRenderer.setMap(map);
            userMarker = new google.maps.Marker({ position: myPos, map: map, icon: 'https://maps.google.com/mapfiles/kml/pal4/icon62.png' });
            
            // Empezar a buscar viajes
            buscarViajes();
        });
    }
}

function buscarViajes() {
    // Simulamos la escucha del servidor (Luego lo conectaremos a tu MongoDB)
    setInterval(() => {
        const viajeGuardado = JSON.parse(localStorage.getItem("nuevoViajePendiente"));
        if(viajeGuardado && !document.getElementById("btnAceptar").disabled) {
            document.getElementById("panelSolicitud").querySelector("h3").innerText = "¡PEDIDO RECIBIDO!";
            document.getElementById("detalleViaje").classList.add("hidden");
            document.getElementById("datosViaje").classList.remove("hidden");
            document.getElementById("rutaTexto").innerText = "De " + viajeGuardado.origen + " a " + viajeGuardado.destino;
            document.getElementById("precioTexto").innerText = "$" + viajeGuardado.precio;
            
            // Dibujar la ruta en el mapa del chofer
            trazarRuta(viajeGuardado);
        }
    }, 3000);
}

function trazarRuta(viaje) {
    const request = {
        origin: viaje.origen,
        destination: viaje.destino,
        travelMode: 'DRIVING'
    };
    directionsService.route(request, (result, status) => {
        if (status == 'OK') directionsRenderer.setDirections(result);
    });
}

function aceptarViaje() {
    alert("Viaje confirmado. El pasajero está siendo notificado.");
    document.getElementById("btnAceptar").innerText = "EN CAMINO...";
    document.getElementById("btnAceptar").disabled = true;
    document.getElementById("btnAceptar").style.background = "#444";
}

function cerrarSesion() {
    localStorage.removeItem("sesion");
    location.href = "/";
}

initMap();
</script>
</body>
</html>
